<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missouri Paycheck Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            padding: 32px;
            color: white;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            padding: 32px;
        }

        .input-section,
        .output-section {
            background: #f8fafc;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .output-section {
            background: #fefefe;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #4f46e5;
            border-radius: 2px;
            margin-right: 12px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .required {
            color: #dc2626;
            margin-left: 4px;
        }

        .tooltip {
            margin-left: 8px;
            cursor: help;
            color: #6b7280;
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            margin-left: 100px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            max-width: 500px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Base styling for inputs & selects */
        input,
        select {
            flex: 1;
            padding: 7px 15px;
            height: 44px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .toggle-btn {
            padding: 8px 12px;
            background: #e5e7eb;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 40px;
        }

        .toggle-btn.active {
            background: #4f46e5;
            color: white;
        }

        .external-link {
            color: #4f46e5;
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px;
            margin-top: 4px;
            display: inline-block;
        }

        .buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-reset {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-reset:hover {
            background: #e5e7eb;
        }

        .btn-download {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-download:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        .btn-download:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .results-table th,
        .results-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }

        .results-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        .results-table tr:hover {
            background: #f8fafc;
        }

        .final-pay {
            background: #ecfdf5 !important;
            font-weight: 600;
            color: #059669;
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .calculate-wrapper {
            text-align: center;
            margin-top: 20px;
        }

        .calculate-btn {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #6366f1;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .calculate-btn:hover {
            background-color: #0056b3;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 24px;
                padding: 20px;
            }

            .header {
                padding: 24px 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.6rem;
            }

            .header p {
                font-size: 0.95rem;
            }

            .section-title {
                font-size: 1.1rem;
            }

            .input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }

            /* Make inputs & selects fill and feel larger */
            .input-wrapper input,
            .input-wrapper select {
                width: 100%;
                margin-bottom: 12px;
                padding: 14px 16px;
                font-size: 16px;
                height: auto;
            }

            .toggle-btn {
                width: 100%;
                padding: 12px 0;
            }

            .buttons {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
            }

            .table-title {
                font-size: 1rem;
                text-align: center;
            }

            .output-section {
                overflow-x: auto;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .refresh-icon {
            margin-left: 8px;
            cursor: pointer;
            color: #4f46e5;
        }

        .refresh-icon:hover {
            color: #3730a3;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>💰 Missouri Paycheck Calculator</h1>
            <p>Calculate your take‑home salary with Missouri's slab-based state tax (editable)</p>
        </div>


        <div class="main-content">
            <!-- Input Section -->
            <div class="input-section">
                <h2 class="section-title">Input Details</h2>

                <div class="api-status">
                    <span class="status-dot"></span>
                    <span>Tax rates updated</span>
                    <span class="refresh-icon" onclick="loadTaxRates()">🔄</span>
                </div>

                <!-- Job Income -->
                <div class="input-group">
                    <label class="input-label">
                        Your Job Income <span class="required">*</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="jobIncome" placeholder="60000" required>
                        <select id="incomeType">
                            <option value="hourly">Hourly</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="bi-weekly">Bi‑weekly</option>
                            <option value="semi-monthly">Semi‑monthly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="semi-annually">Semi‑annually</option>
                            <option value="annually" selected>Annually</option>
                        </select>
                    </div>
                </div>

                <!-- Pay Frequency -->
                <div class="input-group">
                    <label class="input-label">
                        Pay Frequency <span class="required">*</span>
                        <span class="tooltip"
                            data-tooltip="	U.S. federal tax applies in  Missouri Ranges 10%-37%.">❓</span>
                    </label>
                    <select id="payFrequency" required>
                        <option value="hourly">Hourly</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="bi-weekly">Bi‑weekly</option>
                        <option value="semi-monthly">Semi‑monthly</option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="semi-annually">Semi‑annually</option>
                        <option value="annually">Annually</option>
                    </select>
                </div>

                <!-- Filing Status -->
                <div class="input-group">
                    <label class="input-label">
                        Filing Status <span class="required">*</span>
                        <span class="tooltip"
                            data-tooltip=" Missouri state tax rate depends on your filing status and annual income.">❓</span>
                    </label>
                    <select id="filingStatus" onchange="calculatePaycheck()">
                        <option value="single">Single</option>
                        <option value="married">Married Filing Jointly</option>
                    </select>

                </div>

                <!-- Federal Income Tax -->
                <div class="input-group">
                    <label class="input-label">
                        Federal Income Tax <span class="required">*</span>
                        <span class="tooltip"
                            data-tooltip="Mandatory tax by U.S. federal government. Ranges from 10%–37% (2025).">❓</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="federalTax" value="22" step="0.01" required>
                        <button type="button" class="toggle-btn active" onclick="toggleUnit('federal')">%</button>
                        <button type="button" class="toggle-btn" onclick="toggleUnit('federal')">$</button>
                    </div>
                </div>

                <!-- Social Security Tax -->
                <div class="input-group">
                    <label class="input-label">
                        Social Security Tax
                        <span class="tooltip" data-tooltip="Required 6.2% contribution by federal law.">❓</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="socialSecurityTax" value="6.2" step="0.01">
                        <button type="button" class="toggle-btn active"
                            onclick="toggleUnit('socialSecurity')">%</button>
                        <button type="button" class="toggle-btn" onclick="toggleUnit('socialSecurity')">$</button>
                    </div>
                </div>

                <!-- Medicare Tax -->
                <div class="input-group">
                    <label class="input-label">
                        Medicare Tax
                        <span class="tooltip"
                            data-tooltip="Medicare tax is 1.45%, mandatory across all states.">❓</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="medicareTax" value="1.45" step="0.01">
                        <button type="button" class="toggle-btn active" onclick="toggleUnit('medicare')">%</button>
                        <button type="button" class="toggle-btn" onclick="toggleUnit('medicare')">$</button>
                    </div>
                </div>

                <!-- State Income Tax -->
                <div class="input-group">
                    <label class="input-label">
                        State Income Tax
                        <span class="tooltip"
                            data-tooltip=" Missouri's tax is slab-based and depends on your filing status and income.">❓</span>
                    </label>
                    <div class="input-wrapper">
                        <input id="stateTax" type="number" oninput="this.setAttribute('data-user-modified', 'true')">
                        <button type="button" class="toggle-btn active" onclick="toggleUnit('state')">%</button>
                        <button type="button" class="toggle-btn" onclick="toggleUnit('state')">$</button>
                    </div>
                    <div class="external-link"
                        onclick="window.open('https://en.wikipedia.org/wiki/State_income_tax', '_blank')">
                        click here to check
                    </div>
                    <div id="stateRateInfo" style="font-size: 12px; color: #4f46e5; margin-top: 4px;"></div>

                </div>

                <!-- City Income Tax -->
                <div class="input-group">
                    <label class="input-label">
                        City Income Tax
                        <span class="tooltip"
                            data-tooltip="	Some  Missouri counties may apply extra local tax (optional).">❓</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="cityTax" placeholder="0" step="0.01">
                        <button type="button" class="toggle-btn active" onclick="toggleUnit('city')">%</button>
                        <button type="button" class="toggle-btn" onclick="toggleUnit('city')">$</button>
                    </div>
                </div>

                <!-- Pre-Tax Deductions -->
                <div class="input-group">
                    <label class="input-label">
                        Pre-Tax Deductions
                        <span class="tooltip"
                            data-tooltip="401(k), HSA, or insurance premiums—deducted before tax.">❓</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="preTaxDeductions" placeholder="0" step="0.01">
                        <button type="button" class="toggle-btn active" onclick="toggleUnit('preTax')">%</button>
                        <button type="button" class="toggle-btn" onclick="toggleUnit('preTax')">$</button>
                    </div>
                </div>

                <!-- Post-Tax Deductions -->
                <div class="input-group">
                    <label class="input-label">
                        Post-Tax Deductions
                        <span class="tooltip"
                            data-tooltip="Child support, union dues, etc. - deducted after tax.">❓</span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="postTaxDeductions" placeholder="0" step="0.01">
                        <button type="button" class="toggle-btn active" onclick="toggleUnit('postTax')">%</button>
                        <button type="button" class="toggle-btn" onclick="toggleUnit('postTax')">$</button>
                    </div>
                </div>

                <div class="calculate-wrapper">
                    <button class="btn calculate-btn" onclick="handleCalculate()">Calculate</button>
                </div>

                <div class="buttons">
                    <button class="btn btn-reset" onclick="resetAll()">Reset All</button>
                    <button class="btn btn-download" id="downloadBtn" onclick="downloadPDF()" disabled>
                        Download Paycheck Report
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div id="results" class="output-section">
                <h2 class="section-title">Calculation Results</h2>

                <!-- Primary Results (First Box) -->
                <div id="primaryResults">
                    <div class="table-title" id="primaryTitle">Monthly Paycheck Based on Income of $0/year</div>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Amount ($)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Gross Pay</td>
                                <td id="primary-gross">$0.00</td>
                            </tr>
                            <tr>
                                <td>Federal Income Tax</td>
                                <td id="primary-federal">$0.00</td>
                            </tr>
                            <tr>
                                <td>Social Security Tax</td>
                                <td id="primary-social">$0.00</td>
                            </tr>
                            <tr>
                                <td>Medicare Tax</td>
                                <td id="primary-medicare">$0.00</td>
                            </tr>
                            <tr>
                                <td>State Income Tax</td>
                                <td id="primary-state">$0.00</td>
                            </tr>
                            <tr>
                                <td>City Income Tax</td>
                                <td id="primary-city">$0.00</td>
                            </tr>
                            <tr>
                                <td>Pre-Tax Deductions</td>
                                <td id="primary-pretax">$0.00</td>
                            </tr>
                            <tr>
                                <td>Post-Tax Deductions</td>
                                <td id="primary-posttax">$0.00</td>
                            </tr>
                            <tr class="final-pay">
                                <td><strong>Final Pay Check</strong></td>
                                <td id="primary-final"><strong>$0.00</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Secondary Results (Second Box) -->
                <div id="secondaryResults" style="display: none;">
                    <div class="table-title" id="secondaryTitle">Monthly Paycheck Based on Income of $0/year</div>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Amount ($)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Gross Pay</td>
                                <td id="secondary-gross">$0.00</td>
                            </tr>
                            <tr>
                                <td>Federal Income Tax</td>
                                <td id="secondary-federal">$0.00</td>
                            </tr>
                            <tr>
                                <td>Social Security Tax</td>
                                <td id="secondary-social">$0.00</td>
                            </tr>
                            <tr>
                                <td>Medicare Tax</td>
                                <td id="secondary-medicare">$0.00</td>
                            </tr>
                            <tr>
                                <td>State Income Tax</td>
                                <td id="secondary-state">$0.00</td>
                            </tr>
                            <tr>
                                <td>City Income Tax</td>
                                <td id="secondary-city">$0.00</td>
                            </tr>
                            <tr>
                                <td>Pre-Tax Deductions</td>
                                <td id="secondary-pretax">$0.00</td>
                            </tr>
                            <tr>
                                <td>Post-Tax Deductions</td>
                                <td id="secondary-posttax">$0.00</td>
                            </tr>
                            <tr class="final-pay">
                                <td><strong>Final Pay Check</strong></td>
                                <td id="secondary-final"><strong>$0.00</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const taxUnits = {
            federal: '%',
            socialSecurity: '%',
            medicare: '%',
            state: '%',
            city: '%',
            preTax: '%',
            postTax: '%',
        };

        const frequencyMultipliers = {
            hourly: 2080, // 40 hours/week × 52 weeks
            daily: 365,
            weekly: 52,
            'bi-weekly': 26,
            'semi-monthly': 24,
            monthly: 12,
            quarterly: 4,
            'semi-annually': 2,
            annually: 1,
        };

        function toggleUnit(taxType) {
            let inputField = document.getElementById(`${taxType}Tax`) ||
                document.getElementById(`${taxType}Deductions`);
            let buttons = inputField.parentNode.querySelectorAll('.toggle-btn');

            const currentValue = inputField.value;
            taxUnits[taxType] = taxUnits[taxType] === '%' ? '$' : '%';
            buttons.forEach(btn => btn.classList.remove('active'));
            buttons[taxUnits[taxType] === '%' ? 0 : 1].classList.add('active');

            if (currentValue && !inputField.value) inputField.value = currentValue;
            calculatePaycheck();
        }

        function resetAll() {
            ['jobIncome', 'incomeType', 'payFrequency', 'federalTax', 'socialSecurityTax', 'medicareTax', 'stateTax', 'cityTax', 'preTaxDeductions', 'postTaxDeductions']
                .forEach(id => {
                    let el = document.getElementById(id);
                    if (el.tagName === 'SELECT') {
                        if (id === 'payFrequency') el.value = 'monthly';
                        else if (id === 'incomeType') el.value = 'annually';
                        else el.value = el.options[0].value;
                    }
                    else if (['federalTax', 'socialSecurityTax', 'medicareTax'].includes(id))
                        el.value = id === 'federalTax' ? 22 : (id === 'socialSecurityTax' ? 6.2 : 1.45);
                    else el.value = '';
                });
            Object.keys(taxUnits).forEach(key => taxUnits[key] = '%');
            calculatePaycheck();
        }

        function getTaxAmount(val, unit, base) {
            return unit === '%' ? (val / 100) * base : val;
        }

        function getFallbackBrackets() {
            const moBrackets = [
                { limit: 1273, rate: 0, plus: 0 }, // Income $0 to $1,273 is not taxed
                { limit: 2546, rate: 2.0, plus: 0 }, // More than $1,273 to $2,546 is taxed at 2 percent
                { limit: 3819, rate: 2.5, plus: 25 }, // More than $2,546 to $3,819 is taxed at 2.5 percent plus $25
                { limit: 5092, rate: 3.0, plus: 57 }, // More than $3,819 to $5,092 is taxed at 3 percent plus $57
                { limit: 6365, rate: 3.5, plus: 95 }, // More than $5,092 to $6,365 is taxed at 3.5 percent plus $95
                { limit: 7638, rate: 4.0, plus: 140 }, // More than $6,365 to $7,638 is taxed at 4 percent plus $140
                { limit: 8911, rate: 4.5, plus: 191 }, // More than $7,638 to $8,911 is taxed at 4.5 percent plus $191
                { limit: Infinity, rate: 4.8, plus: 243 } // More than $8,911 is taxed at 4.8 percent plus $243 (2025 rate)
            ];

            return {
                single: moBrackets,
                married: moBrackets
            };
        }

        // Missouri logic
        function getMissouriStateTaxDetails(annualIncome, filingStatus) {
            let brackets = window.liveTaxBrackets || getFallbackBrackets();
            const selectedBrackets = brackets[filingStatus];

            let applied = null;
            let previousLimit = 0;

            // Find the correct bracket
            for (let i = 0; i < selectedBrackets.length; i++) {
                if (annualIncome <= selectedBrackets[i].limit) {
                    applied = selectedBrackets[i];
                    break;
                }
                previousLimit = selectedBrackets[i].limit;
            }

            // If no bracket found (shouldn't happen with Infinity), use the last one
            if (!applied) {
                applied = selectedBrackets[selectedBrackets.length - 1];
                previousLimit = selectedBrackets[selectedBrackets.length - 2].limit;
            }

            // Calculate tax based on the bracket
            const excessIncome = Math.max(0, annualIncome - previousLimit);
            const calculatedTax = applied.plus + (excessIncome * (applied.rate / 100));

            return {
                rate: applied.rate,
                bracketText: `>$${previousLimit.toLocaleString()}`,
                calculatedTax: Math.max(0, parseFloat(calculatedTax.toFixed(2)))
            };
        }

        function updateStateTaxAutomatically() {
            const jobIncome = +document.getElementById('jobIncome').value || 0;
            const incomeType = document.getElementById('incomeType').value;
            const annualSalary = jobIncome * frequencyMultipliers[incomeType];
            const filingStatus = document.getElementById('filingStatus').value;

            const {
                rate: suggestedStateRate,
                bracketText,
                calculatedTax
            } = getMissouriStateTaxDetails(annualSalary, filingStatus);

            const stateTaxInput = document.getElementById('stateTax');
            const rateInfo = document.getElementById('stateRateInfo');

            if (!stateTaxInput.getAttribute('data-user-modified')) {
                // Optional: show rate for display only (do NOT rely on this as your real tax)
                stateTaxInput.value = suggestedStateRate;

                rateInfo.textContent = `Auto-applied Missouri state tax: ${suggestedStateRate}% — based on bracket ${bracketText}.`;
            }
        }

        function loadTaxRates() {
            // Load federal rates
            ['federalTax', 'socialSecurityTax', 'medicareTax'].forEach((id, idx) => {
                document.getElementById(id).value = idx === 0 ? 22 : (idx === 1 ? 6.2 : 1.45);
            });

            // Fetch live Missouri tax data
            fetchLiveTaxData();
        }

        async function fetchLiveTaxData() {

            const response = await fetch('https://api.taxrates.com/v1/missouri/income-tax-brackets', {
                headers: {
                    'Authorization': 'Bearer YOUR_API_KEY',
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error('Failed to fetch tax data');

            const taxData = await response.json();

            // ✅ Set live data globally
            window.liveTaxBrackets = {
                single: taxData.single_brackets,
                married: taxData.married_brackets
            };

            document.querySelector('.api-status .status-dot').style.background = '#10b981';
            document.querySelector('.api-status span').textContent = 'Tax rates updated (Live)';
            calculatePaycheck();


        }

        function calculatePaycheck() {
            const jobIncome = +document.getElementById('jobIncome').value || 0;
            const incomeType = document.getElementById('incomeType').value;
            const payFrequency = document.getElementById('payFrequency').value;
            const annualSalary = jobIncome * frequencyMultipliers[incomeType];
            const filingStatus = document.getElementById('filingStatus')?.value || 'single';

            const stateTaxInput = document.getElementById('stateTax');
            const rateInfo = document.getElementById('stateRateInfo');

            // ✅ Get full Missouri tax info including exact tax amount
            const {
                rate: suggestedStateRate,
                bracketText,
                calculatedTax
            } = getMissouriStateTaxDetails(annualSalary, filingStatus);

            // ✅ Only auto-apply % rate if user hasn't modified manually
            if (!stateTaxInput.getAttribute('data-user-modified')) {
                stateTaxInput.value = suggestedStateRate;
                rateInfo.textContent = `Auto-applied Missouri state tax: ${suggestedStateRate}% — based on your income and filing status bracket ${bracketText}.`;
            } else {
                rateInfo.textContent = `(You manually modified the state tax rate)`;
            }

            // Calculate MONTHLY amounts (always divide annual by 12)
            const monthlyGrossPay = annualSalary / 12;
            const monthlyPreTax = getTaxAmount(+document.getElementById('preTaxDeductions').value, taxUnits.preTax, monthlyGrossPay);
            const monthlyTaxableIncome = monthlyGrossPay - monthlyPreTax;

            const monthlyFed = getTaxAmount(+document.getElementById('federalTax').value, taxUnits.federal, monthlyTaxableIncome);
            const monthlyState = calculatedTax / 12; // Annual state tax divided by 12 months
            const monthlyCity = getTaxAmount(+document.getElementById('cityTax').value, taxUnits.city, monthlyTaxableIncome);
            const monthlySocial = getTaxAmount(+document.getElementById('socialSecurityTax').value, taxUnits.socialSecurity, monthlyTaxableIncome);
            const monthlyMedicare = getTaxAmount(+document.getElementById('medicareTax').value, taxUnits.medicare, monthlyTaxableIncome);
            const monthlyPostTax = getTaxAmount(+document.getElementById('postTaxDeductions').value, taxUnits.postTax, monthlyGrossPay);

            const monthlyTotalTaxes = monthlyFed + monthlyState + monthlyCity + monthlySocial + monthlyMedicare;
            const monthlyFinalPay = monthlyGrossPay - monthlyPreTax - monthlyTotalTaxes - monthlyPostTax;

            // Calculate FREQUENCY-SPECIFIC amounts (based on selected pay frequency)
            const freqGrossPay = annualSalary / frequencyMultipliers[payFrequency];
            const freqPreTax = getTaxAmount(+document.getElementById('preTaxDeductions').value, taxUnits.preTax, freqGrossPay);
            const freqTaxableIncome = freqGrossPay - freqPreTax;

            const freqFed = getTaxAmount(+document.getElementById('federalTax').value, taxUnits.federal, freqTaxableIncome);
            const freqState = calculatedTax / frequencyMultipliers[payFrequency]; // Annual state tax divided by frequency
            const freqCity = getTaxAmount(+document.getElementById('cityTax').value, taxUnits.city, freqTaxableIncome);
            const freqSocial = getTaxAmount(+document.getElementById('socialSecurityTax').value, taxUnits.socialSecurity, freqTaxableIncome);
            const freqMedicare = getTaxAmount(+document.getElementById('medicareTax').value, taxUnits.medicare, freqTaxableIncome);
            const freqPostTax = getTaxAmount(+document.getElementById('postTaxDeductions').value, taxUnits.postTax, freqGrossPay);

            const freqTotalTaxes = freqFed + freqState + freqCity + freqSocial + freqMedicare;
            const freqFinalPay = freqGrossPay - freqPreTax - freqTotalTaxes - freqPostTax;

            // Format function
            const fmt = v => `${v.toFixed(2)}`;

            // NEW UI LOGIC: Swap display boxes based on pay frequency
            if (payFrequency === 'monthly') {
                // When monthly: Show only first box with monthly calculations
                document.getElementById('primaryResults').style.display = 'block';
                document.getElementById('secondaryResults').style.display = 'none';

                // Primary box shows monthly data
                document.getElementById('primaryTitle').textContent =
                    `Monthly Paycheck Based on Income of ${annualSalary.toLocaleString()}/year`;
                document.getElementById('primary-gross').textContent = fmt(monthlyGrossPay);
                document.getElementById('primary-pretax').textContent = `-${fmt(monthlyPreTax)}`;
                document.getElementById('primary-federal').textContent = `-${fmt(monthlyFed)}`;
                document.getElementById('primary-state').textContent = `-${fmt(monthlyState)}`;
                document.getElementById('primary-city').textContent = `-${fmt(monthlyCity)}`;
                document.getElementById('primary-social').textContent = `-${fmt(monthlySocial)}`;
                document.getElementById('primary-medicare').textContent = `-${fmt(monthlyMedicare)}`;
                document.getElementById('primary-posttax').textContent = `-${fmt(monthlyPostTax)}`;
                document.getElementById('primary-final').textContent = fmt(monthlyFinalPay);

            } else {
                // When non-monthly: Show both boxes, swap their content
                document.getElementById('primaryResults').style.display = 'block';
                document.getElementById('secondaryResults').style.display = 'block';

                const capFreq = payFrequency.charAt(0).toUpperCase() + payFrequency.slice(1);

                // Primary box shows selected frequency data
                document.getElementById('primaryTitle').textContent =
                    `${capFreq} Paycheck Based on Income of ${annualSalary.toLocaleString()}/year`;
                document.getElementById('primary-gross').textContent = fmt(freqGrossPay);
                document.getElementById('primary-pretax').textContent = `-${fmt(freqPreTax)}`;
                document.getElementById('primary-federal').textContent = `-${fmt(freqFed)}`;
                document.getElementById('primary-state').textContent = `-${fmt(freqState)}`;
                document.getElementById('primary-city').textContent = `-${fmt(freqCity)}`;
                document.getElementById('primary-social').textContent = `-${fmt(freqSocial)}`;
                document.getElementById('primary-medicare').textContent = `-${fmt(freqMedicare)}`;
                document.getElementById('primary-posttax').textContent = `-${fmt(freqPostTax)}`;
                document.getElementById('primary-final').textContent = fmt(freqFinalPay);

                // Secondary box shows monthly data for comparison
                document.getElementById('secondaryTitle').textContent =
                    `Monthly Paycheck Based on Income of ${annualSalary.toLocaleString()}/year`;
                document.getElementById('secondary-gross').textContent = fmt(monthlyGrossPay);
                document.getElementById('secondary-pretax').textContent = `-${fmt(monthlyPreTax)}`;
                document.getElementById('secondary-federal').textContent = `-${fmt(monthlyFed)}`;
                document.getElementById('secondary-state').textContent = `-${fmt(monthlyState)}`;
                document.getElementById('secondary-city').textContent = `-${fmt(monthlyCity)}`;
                document.getElementById('secondary-social').textContent = `-${fmt(monthlySocial)}`;
                document.getElementById('secondary-medicare').textContent = `-${fmt(monthlyMedicare)}`;
                document.getElementById('secondary-posttax').textContent = `-${fmt(monthlyPostTax)}`;
                document.getElementById('secondary-final').textContent = fmt(monthlyFinalPay);
            }

            // Enable download button if valid
            const isValid = document.getElementById('jobIncome').value.trim() && document.getElementById('federalTax').value.trim();
            document.getElementById('downloadBtn').disabled = !isValid;

            // Final UI update for tax info (this line will still run even if user modified it)
            document.getElementById('stateRateInfo').textContent =
                `Auto-applied Missouri state tax: ${suggestedStateRate}% — based on your income and filing status bracket ${bracketText}.`;
        }

        function handleCalculate() {
            calculatePaycheck();
            document.querySelector('#results').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;

            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            let y = 40;

            // 🏷 Title
            doc.setFont('helvetica', 'bold').setFontSize(18).text('Missouri Paycheck Report', 40, y);
            y += 24;

            // 🕒 Timestamp
            doc.setFont('helvetica', 'normal').setFontSize(10)
                .text(`Generated on: ${new Date().toLocaleString()}`, 40, y);
            y += 18;

            // ✏️ THICK SEPARATOR LINE
            doc.setDrawColor(50, 50, 50); // Dark gray
            doc.setLineWidth(1);          // Thicker
            doc.line(40, y, 555, y);      // Line across the page
            y += 20;

            // 📋 Filing Info
            const filingStatus = document.getElementById('filingStatus')?.value || 'single';
            const jobIncome = +document.getElementById('jobIncome').value || 0;
            const incomeType = document.getElementById('incomeType').value;
            const annualSalary = jobIncome * frequencyMultipliers[incomeType];
            const stateTaxInput = document.getElementById('stateTax');

            doc.setFont('helvetica', 'normal').setFontSize(10)
                .text(`Filing Status: ${filingStatus === 'married' ? 'Married Filing Jointly' : 'Single Filer'}`, 40, y);
            y += 14;
            doc.text(`Missouri State Tax Rate Used: ${stateTaxInput.value}%`, 40, y);
            y += 14;

            // ✅ Clean bracket explanation
            const { rate, bracketText } = getMissouriStateTaxDetails(annualSalary, filingStatus);
            doc.text(`State Tax Applied (Auto): ${rate}% — based on Missouri bracket ${bracketText}`, 40, y);
            y += 20;

            // RECALCULATE VALUES FOR PDF (independent of UI elements)
            const { calculatedTax } = getMissouriStateTaxDetails(annualSalary, filingStatus);

            // Monthly calculations for PDF
            const monthlyGrossPay = annualSalary / 12;
            const monthlyPreTax = getTaxAmount(+document.getElementById('preTaxDeductions').value, taxUnits.preTax, monthlyGrossPay);
            const monthlyTaxableIncome = monthlyGrossPay - monthlyPreTax;
            const monthlyFed = getTaxAmount(+document.getElementById('federalTax').value, taxUnits.federal, monthlyTaxableIncome);
            const monthlyState = calculatedTax / 12;
            const monthlyCity = getTaxAmount(+document.getElementById('cityTax').value, taxUnits.city, monthlyTaxableIncome);
            const monthlySocial = getTaxAmount(+document.getElementById('socialSecurityTax').value, taxUnits.socialSecurity, monthlyTaxableIncome);
            const monthlyMedicare = getTaxAmount(+document.getElementById('medicareTax').value, taxUnits.medicare, monthlyTaxableIncome);
            const monthlyPostTax = getTaxAmount(+document.getElementById('postTaxDeductions').value, taxUnits.postTax, monthlyGrossPay);
            const monthlyFinalPay = monthlyGrossPay - monthlyPreTax - monthlyFed - monthlyState - monthlyCity - monthlySocial - monthlyMedicare - monthlyPostTax;

            const addSection = (title, data) => {
                doc.setFont('helvetica', 'bold').setFontSize(13).text(title, 40, y); y += 14;
                doc.setFont('helvetica', 'normal').setFontSize(11);
                data.forEach(([lbl, amt]) => {
                    doc.text(lbl, 40, y);
                    doc.text(amt, 400, y, { align: 'right' });
                    y += 14;
                });
                y += 10;
            };

            // ALWAYS put monthly data first in PDF
            const monthlyData = [
                ['Gross Pay', `${monthlyGrossPay.toFixed(2)}`],
                ['Pre-Tax Deductions', `-${monthlyPreTax.toFixed(2)}`],
                ['Federal Income Tax', `-${monthlyFed.toFixed(2)}`],
                ['State Income Tax', `-${monthlyState.toFixed(2)}`],
                ['City Income Tax', `-${monthlyCity.toFixed(2)}`],
                ['Social Security Tax', `-${monthlySocial.toFixed(2)}`],
                ['Medicare Tax', `-${monthlyMedicare.toFixed(2)}`],
                ['Post-Tax Deductions', `-${monthlyPostTax.toFixed(2)}`],
                ['Final Paycheck', `${monthlyFinalPay.toFixed(2)}`],
            ];
            addSection('Monthly Breakdown', monthlyData);

            // Add frequency-specific section if not monthly
            const freq = document.getElementById('payFrequency').value;
            if (freq !== 'monthly') {
                // Frequency calculations for PDF
                const freqGrossPay = annualSalary / frequencyMultipliers[freq];
                const freqPreTax = getTaxAmount(+document.getElementById('preTaxDeductions').value, taxUnits.preTax, freqGrossPay);
                const freqTaxableIncome = freqGrossPay - freqPreTax;
                const freqFed = getTaxAmount(+document.getElementById('federalTax').value, taxUnits.federal, freqTaxableIncome);
                const freqState = calculatedTax / frequencyMultipliers[freq];
                const freqCity = getTaxAmount(+document.getElementById('cityTax').value, taxUnits.city, freqTaxableIncome);
                const freqSocial = getTaxAmount(+document.getElementById('socialSecurityTax').value, taxUnits.socialSecurity, freqTaxableIncome);
                const freqMedicare = getTaxAmount(+document.getElementById('medicareTax').value, taxUnits.medicare, freqTaxableIncome);
                const freqPostTax = getTaxAmount(+document.getElementById('postTaxDeductions').value, taxUnits.postTax, freqGrossPay);
                const freqFinalPay = freqGrossPay - freqPreTax - freqFed - freqState - freqCity - freqSocial - freqMedicare - freqPostTax;

                const freqData = [
                    ['Gross Pay', `${freqGrossPay.toFixed(2)}`],
                    ['Pre-Tax Deductions', `-${freqPreTax.toFixed(2)}`],
                    ['Federal Income Tax', `-${freqFed.toFixed(2)}`],
                    ['State Income Tax', `-${freqState.toFixed(2)}`],
                    ['City Income Tax', `-${freqCity.toFixed(2)}`],
                    ['Social Security Tax', `-${freqSocial.toFixed(2)}`],
                    ['Medicare Tax', `-${freqMedicare.toFixed(2)}`],
                    ['Post-Tax Deductions', `-${freqPostTax.toFixed(2)}`],
                    ['Final Paycheck', `${freqFinalPay.toFixed(2)}`],
                ];
                addSection(`${freq.charAt(0).toUpperCase() + freq.slice(1)} Breakdown`, freqData);
            }

            y += 4;
            doc.setFontSize(9).setFont('helvetica', 'italic').setTextColor(100)
                .text('This report is an automated estimate and should be verified with a tax professional.', 40, y);
            y += 10;
            doc.text('Powered by Missouri Paycheck Calculator © 2025', 40, y);
            doc.save('official-paycheck-report.pdf');
        }

        // Auto-refresh tax data daily
        setInterval(fetchLiveTaxData, 24 * 60 * 60 * 1000);

        document.addEventListener('DOMContentLoaded', () => {
            ['payFrequency', 'federalTax', 'socialSecurityTax', 'medicareTax', 'cityTax', 'preTaxDeductions', 'postTaxDeductions']
                .forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    let timeout;
                    el.addEventListener('input', () => {
                        clearTimeout(timeout);
                        timeout = setTimeout(calculatePaycheck, 300);
                    });
                    el.addEventListener('change', () => { clearTimeout(timeout); calculatePaycheck(); });
                    el.addEventListener('focus', () => el.setAttribute('data-prev', el.value));
                    el.addEventListener('blur', () => {
                        if (!el.value && el.getAttribute('data-prev')) el.value = el.getAttribute('data-prev');
                        el.removeAttribute('data-prev');
                    });
                });

            // Add specific event listeners for filing status and income changes
            document.getElementById('filingStatus').addEventListener('change', () => {
                const stateTaxInput = document.getElementById('stateTax');
                stateTaxInput.removeAttribute('data-user-modified');
                calculatePaycheck();
            });

            document.getElementById('jobIncome').addEventListener('input', () => {
                const stateTaxInput = document.getElementById('stateTax');
                // Only reset if user hasn't manually modified the field recently
                if (!stateTaxInput.getAttribute('data-user-modified')) {
                    calculatePaycheck();
                }
            });

            document.getElementById('incomeType').addEventListener('change', () => {
                const stateTaxInput = document.getElementById('stateTax');
                stateTaxInput.removeAttribute('data-user-modified');
                calculatePaycheck();
            });

            // Mark state tax as user-modified when manually changed
            document.getElementById('stateTax').addEventListener('input', function () {
                this.setAttribute('data-user-modified', 'true');
            });

            loadTaxRates();
            // Load live tax data on startup
            fetchLiveTaxData();
            calculatePaycheck();
        });
    </script>
</body>

</html>